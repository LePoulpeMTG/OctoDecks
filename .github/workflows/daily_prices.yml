name: Daily update + export

on:
  schedule:
    - cron: '0 3 * * *'              # 04:00 UTC
  workflow_dispatch:

jobs:
  
  build_daily:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - run: pip install --quiet firebase-admin google-cloud-storage tqdm ijson

    # 1) purge éventuelle
    - name: Delete local DB
      run: rm -f database/octobase_reference.db

    # 2) IMPORT : recrée/maj la DB et insère prices_daily_card
    - name: Import all cards + daily prices
      run: python tools/import_all_cards.py
    - name: Cartes du jour ?
      run: |
        sqlite3 database/octobase_reference.db \
          "SELECT date, COUNT(*) FROM prices_daily_card GROUP BY date ORDER BY date DESC LIMIT 3;"

    # 2.5)  debug
    - name: DEBUG – cartes du jour
      run: |
        sqlite3 database/octobase_reference.db "
          SELECT date, COUNT(*) 
          FROM prices_daily_card 
          GROUP BY date 
          ORDER BY date DESC 
          LIMIT 3;
        "

    - name: DEBUG – cartes du jour AVEC prints
      run: |
        sqlite3 database/octobase_reference.db "
          SELECT COUNT(*) 
          FROM prices_daily_card AS d
          JOIN prints           AS p ON p.scryfall_id = d.scryfall_id
          WHERE d.date = date('now');
        "

    - name: DEBUG – set_code résolus
      run: |
        sqlite3 database/octobase_reference.db "
          SELECT COUNT(DISTINCT s.set_code)
          FROM prices_daily_card AS d
          JOIN prints            AS p ON p.scryfall_id = d.scryfall_id
          JOIN sets              AS s ON s.set_id      = p.set_id
          WHERE d.date = date('now');
        "

    # 3) EXPORT : calcule prices_daily_set et génère JSON
    - name: Export daily prices to JSON
      run: python tools/export_daily_prices.py


    # 4) Upload DB + JSON
    - name: Upload DB + JSON vers Firebase
      env:
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        FIREBASE_BUCKET:          ${{ secrets.FIREBASE_BUCKET }}
      run: |
        python - <<'PY'
        from datetime import datetime, timezone
        import json, os, firebase_admin
        from firebase_admin import credentials, storage as fb_storage

        # --- Init Firebase ---
        cred_json = json.loads(os.environ['FIREBASE_SERVICE_ACCOUNT'])
        cred      = credentials.Certificate(cred_json)
        firebase_admin.initialize_app(cred, {
            'storageBucket': os.environ['FIREBASE_BUCKET']
        })

        bucket = fb_storage.bucket()

        # 1️⃣  Upload / écrase la base SQLite
        bucket.blob("octobase/octobase_reference.db").upload_from_filename(
            "database/octobase_reference.db",
            content_type="application/octet-stream"
        )


        print("✅ Upload DB + JSON terminé")
        PY
