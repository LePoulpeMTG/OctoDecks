name: Daily update + export

on:
  schedule:
    - cron: '0 3 * * *'              # 04:00 UTC
  workflow_dispatch:

jobs:
  
  build_daily:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - run: pip install --quiet firebase-admin google-cloud-storage tqdm ijson

    # 1) purge √©ventuelle
    - name: Delete local DB
      run: rm -f database/octobase_reference.db
    # 1.5) purge √©ventuelle  
    - name: Remove tag file
      run: rm -f tools/data/last_bulk_tag.txt
    # 2) IMPORT : recr√©e/maj la DB et ins√®re prices_daily_card
    - name: Import all cards + daily prices
      run: python tools/import_all_cards.py


    - name: Cartes du jour ?
      run: |
        sqlite3 database/octobase_reference.db \
          "SELECT date, COUNT(*) FROM prices_daily_card GROUP BY date ORDER BY date DESC LIMIT 3;"


    # 3) EXPORT : calcule prices_daily_set et g√©n√®re JSON
    - name: Export daily prices to JSON
      run: python tools/export_daily_prices.py
    # juste apr√®s l‚Äô√©tape ‚ÄúExport daily prices to JSON‚Äù
    - name: Export sets.json
      run: python tools/export_sets.py

    - name: Upload sets.json
      env:
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        FIREBASE_BUCKET:          ${{ secrets.FIREBASE_BUCKET }}
      run: |
        python - <<'PY'
        import json, os, firebase_admin
        from firebase_admin import credentials, storage
        cred = credentials.Certificate(json.loads(os.environ['FIREBASE_SERVICE_ACCOUNT']))
        firebase_admin.initialize_app(cred, {'storageBucket': os.environ['FIREBASE_BUCKET']})
        storage.bucket().blob('exports/sets.json').upload_from_filename(
            'exports/sets.json',
            content_type='application/json')
        print("üì§ sets.json upload√©")
        PY



    # 4) Upload DB + JSON
    - name: Upload DB + JSON vers Firebase
      env:
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        FIREBASE_BUCKET:          ${{ secrets.FIREBASE_BUCKET }}
      run: |
        python - <<'PY'
        from datetime import datetime, timezone
        import json, os, firebase_admin
        from firebase_admin import credentials, storage as fb_storage

        # --- Init Firebase ---
        cred_json = json.loads(os.environ['FIREBASE_SERVICE_ACCOUNT'])
        cred      = credentials.Certificate(cred_json)
        firebase_admin.initialize_app(cred, {
            'storageBucket': os.environ['FIREBASE_BUCKET']
        })

        bucket = fb_storage.bucket()

        # 1Ô∏è‚É£  Upload / √©crase la base SQLite
        bucket.blob("octobase/octobase_reference.db").upload_from_filename(
            "database/octobase_reference.db",
            content_type="application/octet-stream"
        )


        print("‚úÖ Upload DB + JSON termin√©")
        PY
