name: Daily update + export

on:
  schedule:
    - cron: '0 3 * * *'              # 03:00 UTC
  workflow_dispatch:

jobs:
  
  build_daily:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - run: pip install --quiet firebase-admin google-cloud-storage tqdm ijson

    # 1) purge éventuelle
    - name: Delete local DB
      run: rm -f database/octobase_reference.db

    # 2) IMPORT : recrée/maj la DB et insère prices_daily_card
    - name: Import all cards + daily prices
      run: python tools/import_all_cards.py
    - name: Cartes du jour ?
      run: |
        sqlite3 database/octobase_reference.db \
          "SELECT date, COUNT(*) FROM prices_daily_card GROUP BY date ORDER BY date DESC LIMIT 3;"


    # 3) EXPORT : calcule prices_daily_set et génère JSON
    - name: Export daily prices to JSON
      run: python tools/export_daily_prices.py


    # 4) Upload DB + JSON
    - name: Upload DB & JSON
      env:
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        FIREBASE_BUCKET:          ${{ secrets.FIREBASE_BUCKET }}
      run: |
        python - <<'PY'
        import json, os, firebase_admin, datetime, pathlib
        from firebase_admin import credentials, storage as fb_storage
        cred = credentials.Certificate(json.loads(os.environ['FIREBASE_SERVICE_ACCOUNT']))
        firebase_admin.initialize_app(cred, {
            'storageBucket': os.environ['FIREBASE_BUCKET']
        })
        bucket = fb_storage.bucket()
        # DB
        bucket.blob("octobase/octobase_reference.db") \
              .upload_from_filename("database/octobase_reference.db",
                                    content_type="application/octet-stream",
                                    if_generation_match=0)
        # JSON
        today = datetime.datetime.utcnow().strftime("%Y-%m-%d")
        bucket.blob(f"prices/daily/{today}.json") \
              .upload_from_filename("prices_daily.json",
                                    content_type="application/json",
                                    if_generation_match=0)
        print("✅ Upload DB + JSON terminé")
        PY
