name: Update OctoBase

on:
  # D√©clencheur automatique : tous les jours √† 02 h UTC
  schedule:
    - cron: '0 2 * * *'
  # D√©clencheur manuel via bouton "Run workflow"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # 1) R√©cup√®re le code du d√©p√¥t
      - uses: actions/checkout@v4

      # 2) Installe Python 3.11
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3) Installe les d√©pendances n√©cessaires
      - name: Install Python dependencies
        run: pip install ijson tqdm requests firebase-admin
      # 3.5) Purge la BD
      - name: Purge DB dans Firebase
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_BUCKET:          ${{ secrets.FIREBASE_BUCKET }}
        run: |
          python - <<'PY'
          import json, os, firebase_admin
          from firebase_admin import credentials, storage
          if not firebase_admin._apps:
              cred = credentials.Certificate(json.loads(os.environ['FIREBASE_SERVICE_ACCOUNT']))
              firebase_admin.initialize_app(cred, { 'storageBucket': os.environ['FIREBASE_BUCKET'] })
          blob = storage.bucket().blob("octobase/octobase_reference.db")
          if blob.exists():
              blob.delete(); print("‚úÖ Ancienne DB supprim√©e du bucket")
          else:
              print("‚ÑπÔ∏è  Aucune DB √† supprimer")
          PY
          
      - name: DEBUG prices_daily_set
        run: |
          sqlite3 database/octobase_reference.db \
            "PRAGMA table_info(prices_daily_set);"

      # 4) Ex√©cute le script d'import
      - name: Supprimer ancienne base
        run: rm -f database/octobase_reference.db 

      - name: Create database folder
        run: mkdir -p database
      - name: DEBUG table prices_daily_set
        run: |
          sqlite3 database/octobase_reference.db \
            "PRAGMA table_info(prices_daily_set);"

      - name: Run importer script
        run: python tools/import_all_cards.py

      # 5) Charge la base SQLite dans Firebase Storage

      
      - name: Upload DB to Firebase
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_BUCKET:          ${{ secrets.FIREBASE_BUCKET }}
        run: |
          python - <<'PY'
          import json, os, firebase_admin
          from firebase_admin import credentials, storage as fb_storage

          # --- Initialise Firebase ---
          cred = credentials.Certificate(json.loads(os.environ['FIREBASE_SERVICE_ACCOUNT']))
          firebase_admin.initialize_app(cred, {
              'storageBucket': os.environ['FIREBASE_BUCKET']
          })

          bucket = fb_storage.bucket()

          # üëâ upload / √©crase la base SQLite (PAS le JSON ici)
          bucket.blob("octobase/octobase_reference.db").upload_from_filename(
              "database/octobase_reference.db",
              content_type="application/octet-stream"
          )

          print("‚úÖ Upload DB termin√©")
          PY
